name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üìÇ Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install dependencies
        run: npm install

      - name: üöÄ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üèóÔ∏è Build APK with detailed logging
        run: |
          echo "Starting build at $(date)"
          eas build -p android --profile preview --non-interactive --local 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          echo "Build exit code: $BUILD_EXIT_CODE"
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Build failed with exit code $BUILD_EXIT_CODE"
            echo "Last 50 lines of build.log:"
            tail -50 build.log
            exit $BUILD_EXIT_CODE
          fi
        continue-on-error: true

      - name: üíæ Save build log to repo
        run: |
          mkdir -p logs
          cp build.log logs/build-$(date +%Y%m%d-%H%M%S).log
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add logs/
          git commit -m "Add build log" || echo "No changes"
          git push
        if: always()

      - name: üîç Find APK
        run: |
          find . -name "*.apk" -type f | tee apk-list.txt
          if [ -s apk-list.txt ]; then
            echo "‚úÖ APK found:"
            cat apk-list.txt
          else
            echo "‚ùå No APK files found"
          fi
        continue-on-error: true

      - name: üì§ Upload APK (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: "**/*.apk"
        if: always()
